{{define "layout"}}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Probe - {{template "title" .}}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="/static/chart.js"></script>
    {{template "head" .}}
</head>
<body>
    
    <div class="sidebar">
        <div class="logo">
            <!-- <div class="logo-image">
                <img src="/static/logo.png" alt="Awan Teknologi Inovasi">
            </div> -->
            <h1>Probe</h1>
            <p>Monitoring System</p>
        </div>

        <ul class="menu">
            <li class="menu-item">
                <a href="/" class="menu-link {{if eq .Page "dashboard"}}active{{end}}">
                    <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="menu-item">
                <a href="/urls" class="menu-link {{if eq .Page "urls"}}active{{end}}">
                    <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                    </svg>
                    URL
                </a>
            </li>
            <li class="menu-item">
                <a href="/scheduler" class="menu-link {{if eq .Page "scheduler"}}active{{end}}">
                    <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                    </svg>
                    Scheduler
                </a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header-bar">
            <h2>{{template "title" .}}</h2>
            <div class="last-update">
                <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                </svg>
                {{if not .LastCheckedTime.IsZero}}
                    Last update: {{.LastCheckedTime.Format "02 Jan 15:04:05"}}
                {{else}}
                    No probes yet
                {{end}}
            </div>
        </div>

        {{template "content" .}}
    </div>

    {{if eq .Page "dashboard"}}
    <script>
        window.dashboardChartUrlId = {{.SelectedURLID}};
        window.dashboardChartRange = "{{or .ChartRange "1d"}}";
    </script>
    {{end}}

    {{if eq .Page "urls"}}
    <script>
        // Halaman URL: update real-time tanpa reload halaman
        (function () {
            const tbody = document.getElementById('urls_tbody');
            if (!tbody) return;

            function escapeHtml(s) {
                return String(s ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            }

            function formatTime(ts) {
                if (!ts) return '-';
                const d = new Date(ts);
                if (isNaN(d.getTime())) return '-';
                return d.toLocaleString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }

            function rowHtml(u) {
                const isUp = !!u.IsUp;
                const statusBadge = isUp
                    ? '<span class="status-badge status-up">Up</span>'
                    : '<span class="status-badge status-down">Down</span>';
                const avg = (u.TotalProbeCount && u.TotalProbeCount > 0) ? Math.round(u.TotalLatencySum / u.TotalProbeCount) + ' ms' : 'N/A';
                const lastChecked = formatTime(u.LastChecked);
                const mode = u.ProbeMode || 'http';
                const threadCount = u.ThreadCount || 1;

                return (
                    '<tr>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td><a href="' + escapeHtml(u.URL) + '" class="url-link" target="_blank">' + escapeHtml(u.URL) + '</a></td>' +
                        '<td><span class="status-code">' + escapeHtml(mode) + '</span></td>' +
                        '<td><span class="status-code">' + threadCount + '</span></td>' +
                        '<td><span class="status-code">' + (u.LastStatus ?? 0) + '</span></td>' +
                        '<td class="latency">' + (u.LastLatencyMs ?? 0) + ' ms</td>' +
                        '<td class="latency">' + escapeHtml(avg) + '</td>' +
                        '<td>' + escapeHtml(u.Uptime ?? 'N/A') + '</td>' +
                        '<td class="date-time">' + escapeHtml(lastChecked) + '</td>' +
                        '<td>' +
                            '<a href="/delete/' + encodeURIComponent(u.ID) + '" class="action-delete" onclick="return confirm(\'Yakin ingin menghapus ' + escapeHtml(u.URL) + '?\')">' +
                                '<svg class="icon" fill="currentColor" viewBox="0 0 24 24">' +
                                    '<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />' +
                                '</svg>' +
                                'Delete' +
                            '</a>' +
                        '</td>' +
                    '</tr>'
                );
            }

            async function tick() {
                try {
                    const res = await fetch('/api/urls');
                    if (!res.ok) return;
                    const data = await res.json();
                    if (!Array.isArray(data)) return;

                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No URLs available. Please add one.</td></tr>';
                        return;
                    }
                    for (let i = 0; i < data.length; i++) {
                        tbody.insertAdjacentHTML('beforeend', rowHtml(data[i]));
                    }
                } catch (e) {}
            }

            tick();
            setInterval(tick, 2000);
        })();
    </script>
    {{end}}

</body>
</html>
{{end}}